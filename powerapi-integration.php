<?php
/*
Plugin Name: PowerAPI Integration
Description: This plugin integrates PowerAPI to create user accounts when a WooCommerce order is completed.
Version: 1.0
Author: Agence BB® Switzerland
*/

if (!defined('ABSPATH')) {
    exit; // Exit if accessed directly
}

require_once plugin_dir_path(__FILE__) . 'powerapi_controller.php';
require_once plugin_dir_path(__FILE__) . 'powerapi_account_model.php';

// Initialize the PowerAPI controller
$powerapi_controller = new PowerAPIController();


add_action('wp_ajax_sendUserDetails', array($powerapi_controller, 'sendUserDetails'));
add_action('wp_ajax_nopriv_sendUserDetails', array($powerapi_controller, 'sendUserDetails'));

// Add action pour récupérer le token lors de la validation de la commande
add_action("woocommerce_thankyou", array($powerapi_controller, 'getTokenOnOrderCompletion'));

// Add action pour mettre à jour le statut du compte PowerAPI lors de l'annulation d'un abonnement
add_action('woocommerce_subscription_status_cancelled', 'updatePowerapiAccountStatus', 10, 1);

function powerapi_admin_menu() {
    add_menu_page(
        'PowerAPI Accounts', // Page title
        'PowerAPI x MPO', // Menu title
        'manage_options', // Capability required to access the page
        'powerapi_accounts_list', // Menu slug
        'powerapi_accounts_list_callback', // Callback function to render the page
        'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyBpZD0iQ2FscXVlXzIiIGRhdGEtbmFtZT0iQ2FscXVlIDIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDUxMy45NiA3NDYuMjMiPgogIDxkZWZzPgogICAgPHN0eWxlPgogICAgICAuY2xzLTEgewogICAgICAgIGZpbGw6IG5vbmU7CiAgICAgIH0KCiAgICAgIC5jbHMtMSwgLmNscy0yIHsKICAgICAgICBzdHJva2Utd2lkdGg6IDBweDsKICAgICAgfQoKICAgICAgLmNscy0yIHsKICAgICAgICBmaWxsOiAjZjE1YTI0OwogICAgICB9CiAgICA8L3N0eWxlPgogIDwvZGVmcz4KICA8ZyBpZD0iQ2FscXVlXzEtMiIgZGF0YS1uYW1lPSJDYWxxdWUgMSI+CiAgICA8Zz4KICAgICAgPHBhdGggY2xhc3M9ImNscy0xIiBkPSJNMjU4Ljc3LDIxNi4zNmMtMi4yOS0uMjktNC43My0uNDMtNy4wMi0uNDMuNDMsMCwuODYtLjE0LDEuMjktLjE0LDEuODYsMCwzLjg3LjQzLDUuNzMuNTdaIi8+CiAgICAgIDxwYXRoIGNsYXNzPSJjbHMtMiIgZD0iTTEwMi4wMiw0MzEuMjlsMzYuMjUtOTYuMTRjLTE0LjktMjIuNS0yMy42NC00OS4yOS0yMy42NC03OC4yMywwLTc4LjM4LDYzLjc2LTE0Mi4yOCwxNDIuMjgtMTQyLjI4czE0Mi4yOCw2My43NiwxNDIuMjgsMTQyLjI4YzAsNDgtMjMuOTMsOTAuNDEtNjAuMzIsMTE2LjA2LDMuODcsNS4wMSw3LjQ1LDEwLjE3LDEwLjE3LDE2LjA1LDYuMTYuODYsMTIuMTgsMi4yOSwxNy45MSw0LjU5LDIyLjIxLDguMzEsMzkuNjksMjUuOTMsNDguNDMsNDcuNzEsMi41OCwxLjE1LDUuMTYsMi40NCw3LjU5LDMuODdsMy41OCwyLjE1cy43Mi41NywxLjE1Ljg2YzUyLjczLTQ3LjE0LDg2LjI2LTExNS4zNCw4Ni4yNi0xOTEuMTRDNTEzLjY4LDExNS42MywzOTguMTksMCwyNTYuOTEsMGgwQzExNS42MywwLDAsMTE1LjYzLDAsMjU2LjkxYzAsNjIuNzYsMjIuOTMsMTIwLjM2LDYwLjYxLDE2NS4wNiwxLDAsMi4xNS0uMjksMy4xNS0uMjksMTMuNjEsMCwyNi42NSwzLjQ0LDM4LjI2LDkuNloiLz4KICAgICAgPHBhdGggY2xhc3M9ImNscy0yIiBkPSJNNDM4LjMxLDUxNS4xMWMuNzIsMTAuNDYtMS41OCwyMS4wNi03LjMxLDMwLjY2bC05Mi4xMywxNTcuMzMtMS43MiwyLjcyYy0uNDMsMS0xLjI5LDEuNzItMS44NiwyLjcyLS44NiwxLjI5LTEuODYsMi41OC0yLjg3LDMuODctLjg2LDEtMS40MywyLjAxLTIuMjksMi44Ny0zLjAxLDMuNTgtNi4zLDYuNzMtOS44OSw5Ljc0LS43Mi41Ny0xLjQzLDEuMjktMi4xNSwxLjg2LTMuNDQsMi43Mi03LjE2LDUuMy0xMC44OSw3LjQ1LS41Ny40My0xLjI5LjcyLTEuODYsMS0zLjU4LDEuODYtNy4xNiwzLjU4LTEwLjg5LDUuMDEtLjcyLjI5LTEuNDMuNTctMi4xNS44Ni00LjE2LDEuNDMtOC40NSwyLjU4LTEyLjc1LDMuNDQtLjg2LDAtMS43Mi4yOS0yLjcyLjQzLTQuMTYuNTctOC40NSwxLTEyLjc1LDEuMTVoLS43MmMtNC41OSwwLTkuMDMtLjQzLTEzLjYxLTEuMTUtMS4xNS0uMTQtMi40NC0uNDMtMy43My0uNzItMy40NC0uNzItNi43My0xLjU4LTEwLjAzLTIuNTgtMS4yOS0uNDMtMi41OC0uODYtMy44Ny0xLjQzLTQuNDQtMS41OC04Ljc0LTMuNTgtMTIuOS02LjAybC04Mi44Mi00OC40M2MtNi4wMi0zLjU4LTExLjg5LTcuNDUtMTcuNDgtMTEuNjEtNS43My00LjAxLTExLjE4LTguNDUtMTYuMzMtMTMuMTgtNC41OS00LjAxLTguODgtOC40NS0xMi45LTEzLjA0LTQuMDEtNC43My03Ljc0LTkuNi0xMS4xOC0xNC42MmwtNjUuMDUtOTguMTVjLTIuMDEtMy4wMS0zLjU4LTYuMDItNC44Ny05LjE3LTIuNTgtNi40NS0zLjczLTEzLjA0LTMuNTgtMTkuNzcsMC00Ljg3LjcyLTkuODksMi4xNS0xNC42MiwxLjQzLTQuNzMsMy41OC05LjMxLDYuMy0xMy40NywxLjg2LTIuODcsNC4wMS01LjQ0LDYuNDUtNy44OHM1LjE2LTQuNzMsOC4wMi02LjU5bDcuMzEtNC44N2guMTRjMi41OC0xLjcyLDUuNDQtMy4xNSw4LjE3LTQuNDQuODYtLjI5LDEuNzItLjU3LDIuNTgtLjg2LDIuMTUtLjg2LDQuMy0xLjQzLDYuNTktMi4wMS43Mi0uMTQsMS41OC0uMjksMi40NC0uNDMsMi44Ny0uNTcsNS44Ny0uODYsOC43NC0uODYsMy44Ny4xNCw3LjU5LjU3LDExLjMyLDEuNDMsMSwuMjksMi4wMS41NywzLjE1LDEsMi41OC43Miw1LjE2LDEuNzIsNy41OSwyLjg3LDEuMjkuNTcsMi40NCwxLjE1LDMuNTgsMS44NiwyLjI5LDEuMjksNC40NCwyLjg3LDYuNTksNC41OSwxLC43MiwyLjAxLDEuNDMsMi44NywyLjI5LDIuODcsMi43Miw1LjU5LDUuNTksNy43NCw5LjAzbDYuMyw5LjQ2LDQuMTYtMTAuODksNDIuMTMtMTExLjc2LDQwLjY5LTEwNy44OWMxLjI5LTMuMywyLjg3LTYuMyw0LjU5LTkuMzEuNTctLjg2LDEuMTUtMS41OCwxLjg2LTIuNDQsMS4yOS0yLjAxLDIuNzItNC4wMSw0LjMtNS43My43Mi0uODYsMS41OC0xLjU4LDIuMjktMi40NCwxLjg2LTEuNzIsMy43My0zLjQ0LDUuODctNS4wMS41Ny0uNDMsMS4xNS0uODYsMS43Mi0xLjI5LDIuNzItMS44Niw1LjU5LTMuNTgsOC40NS00Ljg3LjcyLS40MywxLjU4LS41NywyLjI5LS44NiwyLjI5LTEsNC43My0xLjg2LDcuMTYtMi40NCwxLS4yOSwyLjAxLS41NywzLjE1LS44NiwyLjI5LS40Myw0LjU5LS43Miw3LjAyLS44NiwxLS4xNCwyLjAxLS4yOSwzLjAxLS4yOSwyLjI5LDAsNC43My4xNCw3LjAyLjQzLDEuMTUsMCwyLjQ0LDAsMy41OC4yOSwzLjQ0LjU3LDcuMDIsMS40MywxMC40NiwyLjcyaDBsMSwuNDNjNS40NCwyLjAxLDEwLjMyLDQuODcsMTQuNzYsOC4zMSw0LjMsMy40NCw4LjE3LDcuNDUsMTEuMzIsMTEuODksNi4xNiw4Ljg4LDkuODksMTkuNDksMTAuMzIsMzAuNTIuMjksNy4zMS0uODYsMTQuNzYtMy41OCwyMi4wN2wtMjkuMDksNzcuMjNjNS4wMS40Myw5Ljg5LDEuMjksMTQuNzYsMy4xNSw3LjQ1LDIuNzIsMTMuOSw3LjAyLDE5LjIsMTIuMTguNzIuNzIsMS4yOSwxLjQzLDEuODYsMi4xNSwxLjU4LDEuNzIsMy4xNSwzLjU4LDQuNDQsNS40NCwyLjU4LDMuNzMsNC43Myw3Ljc0LDYuNDUsMTEuODksMS43Miw0LjMsMi44Nyw4LjYsMy40NCwxMy4xOCwzLjAxLS40Myw1Ljg3LS43Miw4Ljg4LS43MmgyLjU4YzIuMTUsMCw0LjE2LjI5LDYuMy41Ny44Ni4xNCwxLjcyLjE0LDIuNTguNDMsMi44Ny40Myw1LjczLDEuMTUsOC42LDIuMjksNy4zMSwyLjcyLDEzLjYxLDYuODgsMTguNzcsMTEuODksOC43NCw4LjQ1LDE0LjQ3LDE5LjYzLDE2LjQ4LDMxLjUyLDMuNzMuODYsNy41OSwyLjE1LDExLjE4LDMuNzMsMS43Mi43MiwzLjQ0LDEuNDMsNS4xNiwyLjI5bDMuNTgsMi4xNWMzLjE1LDEuODYsNi4xNiw0LjAxLDguNzQsNi40NSwxLDEsMi4xNSwyLjAxLDMuMDEsMy4wMSwyLjg3LDMuMTUsNS4zLDYuNTksNy40NSwxMC4xNyw0LjE2LDcuMzEsNi43MywxNS4xOSw3LjMxLDIzLjVaIi8+CiAgICA8L2c+CiAgPC9nPgo8L3N2Zz4=',
        80 // Position in the menu (optional)
    );
}
add_action('admin_menu', 'powerapi_admin_menu');

function powerapi_accounts_list_callback() {
    require_once plugin_dir_path(__FILE__) . 'views/accounts-list-table.php';
}

// load script , array(), null, true
function powerapi_enqueue_scripts() {
    wp_enqueue_script('powerapi-script', plugin_dir_url(__FILE__) . 'js/powerapi-script.js', array(), null, true);
    wp_localize_script('powerapi-script', 'powerapi', array('ajaxurl' => admin_url('admin-ajax.php')));
}

add_action('wp_enqueue_scripts', 'powerapi_enqueue_scripts');